#!/usr/bin/env python

import requests, re
import urllib.parse as urlparse
from bs4 import BeautifulSoup

class Scanner:
    def __init__(self, url, ignore):
        self.session = requests.Session()
        self.ignore_list = ignore
        self.target_url = url
        self.ulinks = []

    def extract_links(self, url):
        response = self.session.get(url).content
        return_object1 = re.findall(str('(?:\shref=")(.*?)"'), response.decode(errors="ignore"))
        return_object2 = re.findall(str("(?:\shref=')(.*?)'"), response.decode(errors="ignore"))
        return_object = return_object1 + return_object2
        return return_object

    def crawl(self, target=None):
        if target is None:
            target = self.target_url
        links = self.extract_links(target)
        for link in links:
            if "#" in link:
                link = link.split("#")[0]
            try:
                if link[0] == ".":
                    link = link[2:]
            except:
                pass
            link = urlparse.urljoin(target, link)

            if self.target_url in link and link not in self.ulinks and link not in self.ignore_list:
                self.ulinks.append(link)
                self.crawl(link)

    def print_links(self):
        for link in self.ulinks:
            print(link)
        print(len(self.ulinks))

    def extract_forms(self, url):
        response = self.session.get(url)
        html_parse = BeautifulSoup(response.content)
        forms = html_parse.findAll("form")
        return forms

    def submit_form(self, form, inputer, url):
        action_url = urlparse.urljoin(url, (form.get("action")))
        method = form.get("method")
        post_data = {}
        for inputy in form.findAll("input"):
            input_type = inputy.get("type")
            input_name = inputy.get("name")
            value = inputy.get("value")
            if input_type == "text" or input_type == "textarea":
                # if inputy.get("maxlength") is not None:
                #     if int(inputy.get("maxlength")) < len("<script>alert(1)</script>"):
                #         value = "a"
                #     else:
                #         value = inputer
                # else:
                value = inputer
            post_data[input_name] = value
        if method == "post":
            return self.session.post(data=post_data, url=action_url)
        return self.session.get(params=post_data, url=action_url)

    def test_xss_link(self, url):
        xss_test_script = "<script>alert(1)</script>"
        url = url.replace("=", "=" + xss_test_script)
        response = self.session.get(url)

        return xss_test_script in response.content.decode(errors="ignore")

    def test_xss_form(self, form, url):
        xss_test_script = "<sCript>alert(1)</sCriPt>"
        response = self.submit_form(form, xss_test_script, url)
        return xss_test_script in response.content.decode(errors="ignore") or xss_test_script.lower() in response.content.decode(errors="ignore")

    def run_scaner(self):
        for link in self.ulinks:
            forms = self.extract_forms(link)
            for form in forms:
                print("[+] Testing form -> " + link)
                if self.test_xss_form(form, link):
                    print("\n\n[!!!!!] XSS vulnerability detected here in form -> " + link + "\n\n")
            # if "=" in link:
            #     print("[+] Testing this link -> " + link)
            #     if self.test_xss_link(link):
            #         print("\n\n[!!!!!] XSS vulnerability detected here in link -> " + link + "\n\n")
